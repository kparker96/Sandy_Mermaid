---
title: "abaco temperature analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(lubridate)
```

# Import data

## Mermaid Reef
```{r}
# May - October 2015
mermaid1 <- read_csv("Data/Temperature/Mermaid's_Reef_download1.csv", skip = 2) %>%
  clean_names() %>%
  mutate(time = mdy_hms(date_time_gmt_04_00),
         site = "mermaid_reef") %>%
  select(time, site, temp_c)
range(mermaid1$time)
```

```{r}
# August 2018 - January 2019
mermaid2 <- read_csv("Data/Temperature/Mermaid_Reef_8-2018_0.csv", skip = 2) %>%
  clean_names() %>%
  mutate(time = mdy_hms(date_time_gmt_04_00),
         site = "mermaid_reef") %>%
  select(time, site, temp_c) %>%
  slice(1:(n()-20))    # get rid of some wonky data at the end
range(mermaid2$time)
```

## Sandy Cay
```{r}
# May 2015 - October 2015
sandy0 <- read_csv("Data/Temperature/Sandy_Cay_Reef_-_Backreef#8_0.csv", skip = 2) %>%
  clean_names() %>%
  mutate(time = mdy_hms(date_time_gmt_04_00),
         site = "sandy_cay_reef",
         temp_c = (temp_f - 32) * 5/9) %>%
  select(time, site, temp_c) %>%
  slice(100:n())   # get rid of some wonky data at the beginning
range(sandy0$time)
```

```{r}
# October 2015 - August 2016
sandy1 <- read_csv("Data/Temperature/SANDY_Cay_Nursery.csv", skip = 2) %>%
  clean_names() %>%
  mutate(time = mdy_hms(date_time_gmt_04_00),
         site = "sandy_cay_nursery") %>%
  select(time, site, temp_c) %>%
  slice(100:n())   # get rid of some wonky data at the beginning
range(sandy1$time)
```

```{r}
# November 2017 - July 2018
sandy2 <- read_csv("Data/Temperature/Sandy_Cay_Reef_2.csv", skip = 2) %>%
  clean_names() %>%
  mutate(time = mdy_hms(date_time_gmt_05_00),
         site = "sandy_cay_reef") %>%
  select(time, site, temp_c) %>%
  slice(1:(n()-120))    # get rid of some wonky data at the end
range(sandy2$time)
```

# Merge datasets
```{r}
df <- bind_rows(mermaid1, mermaid2, sandy0, sandy1, sandy2) %>%
  mutate(monthday = format(time, format = "%m-%d"))
```

# Plot temperature over time from all temp data
```{r}
ggplot(df, aes(x = time, y = temp_c, color = site)) +
  geom_line(alpha = 0.4) +
  ylim(18, 35)
```

# Plot of temperature over overlapping time period for both sites (2015)
```{r}
temp_overlap <- df %>%
  filter(time < "2015-10-15") %>%
  filter(site != "sandy_cay_nursery")
  
ggplot(temp_overlap, aes(x = time, y = temp_c, color = site)) +
  geom_line(alpha = 0.7, size = 1.2) +
  theme_bw() + 
  theme(panel.grid = element_line(color = "white"),
        axis.title.x = element_text(color = "transparent"),
        axis.title.y = element_text(size = 25),
        axis.text.x = element_text(size = 20, color = "black", margin = margin(t = 5)),
        axis.text.y = element_text(size = 20, color = "black", margin = margin(l = 15)),
        legend.position = c(0.85, 0.15),
        legend.title = element_text(color = "transparent"),
        legend.text = element_text(size = 25)) +
  xlab(label = "Month") +
  ylab(expression("Temperature " ( degree*C))) +
  scale_color_manual(name = "Site", labels = c("Mermaid Reef", "Sandy Cay"), values = c("#F8766D","#00BFC4"))

ggsave(filename = "figures/temp_time.png", width = 350, height = 175, units = "mm")

```

# MR vs SC T Test
```{r}
t.test(temp_c ~ site, data = temp_overlap, paired = FALSE)
```

# Bleaching Threshold: Determining Average Monthly Means 
```{r}
# Converting monthday to just month 
month_temp <- temp_overlap %>%
  mutate(month = case_when(grepl("05-", monthday) ~ "May", (grepl("06-", monthday) ~ "Jun"), 
                          (grepl("07-", monthday) ~ "Jul"),(grepl("08-", monthday) ~ "Aug"),
                          (grepl("09-", monthday) ~ "Sep"),(grepl("10-", monthday) ~ "Oct"))) %>%
  select(site, temp_c, month) 
  
# Sandy Cay Temperature Averages by Month
SC_temp <- month_temp %>%
  filter(site == "sandy_cay_reef")

SC_month_temp <- aggregate(temp_c ~ month, SC_temp, mean)

#Mermaid Reef Temperature Averages by Month
MR_temp <- month_temp %>%
  filter(site == "mermaid_reef")

MR_month_temp <- aggregate(temp_c ~ month, MR_temp, mean)

```

# Bleaching Threshold Figure
```{r}
#Mermaid Reef Temp Over Time 
MR <- temp_overlap %>%
  filter(site == "mermaid_reef") %>%
  ggplot(aes(x = time, y = temp_c)) +
  geom_line(color = "#F8766D") +
  geom_hline(yintercept = 31.96026, color = "red", size = 1.2) +
  ylim(25, 33) +
  theme_bw()

# Sandy Cay Temp OVer Time 
SC <- temp_overlap %>%
  filter(site == "sandy_cay_reef") %>%
  ggplot(aes(x = time, y = temp_c)) +
  geom_line(color = "#00BFC4") +
  geom_hline(yintercept = 31.10791, color = "red", size = 1.2) +
  ylim(25, 33) +
  theme_bw()
  
# Combine Temp Figures for each site 
ggarrange(MR, SC) 
  
```

#Distribution of Recorded Temperature Across Sites
```{r}
library(ggplot2)

# List Temperature Recordings only during overlapping time period
temp_dat <- df %>%
  filter(time < "2015-10-15") %>%
  filter(site != "sandy_cay_nursery") %>%
  select(site, temp_c) %>%
  mutate(site = factor(site, levels = c("sandy_cay_reef", "mermaid_reef")))
  
# Density Plot of Temperature Values Between Sites
ggplot(temp_dat, aes(x = temp_c, fill = site)) +
  geom_density(alpha = 0.6, position = "identity") +
  theme_bw() +
  theme(panel.grid = (element_line(color = "transparent")),
    axis.text.y = element_text(size = 20, color = "black", margin =margin(l = 20)),
        axis.text.x = element_text(size = 20, color = "black"),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        legend.text = element_text(size = 30), 
        legend.position = c(0.25, 0.6)) +
  xlab(expression("Temperature " ( degree*C))) +
  ylab(label = "Frequency") +
  scale_y_continuous(expand = c(0,0))  +
  scale_fill_manual(name="",
                         breaks=c("mermaid_reef", "sandy_cay_reef"),
                         labels=c("Mermaid Reef", "Sandy Cay"), values=c("#F8766D", "#00BFC4"))

ggsave(filename = "figures/temp_dens.png", width = 350, height = 175, units = "mm")
```

#Combined Figure of Temperature over time and Density of Recorded temperature values
```{r}
library(ggpubr)

density_plot <- ggplot(temp_dat, aes(x = temp_c, fill = site)) +
  geom_density(alpha = 0.6, position = "identity") +
  theme_bw() +
  coord_flip() +
  theme(panel.grid = (element_line(color = "transparent")),
    axis.text.y = element_text(size = 18, color = "black", margin =margin(l = 20)),
        axis.text.x = element_text(size = 18, color = "black"),
        axis.title.y = element_text(size = 1, color = "transparent"),
        axis.title.x = element_text(size = 18),
        legend.text = element_text(size = 18),
    legend.direction = "horizontal",
    legend.position = c(-0.1,-0.16),
    legend.spacing.x = unit(0.5, 'cm')) +
  xlab(expression("Temperature " (degree*C))) +
  ylab(label = "Frequency") +
  guides(colour = guide_legend(nrow = 1)) +
  scale_y_continuous(expand = c(0,0))  +
  scale_fill_manual(name="",
                         breaks=c("mermaid_reef", "sandy_cay_reef"),
                         labels=c("Mermaid Reef", "Sandy Cay Reef"), values=c( "#00BFC4", "#F8766D"))

temp_time_overlap <- ggplot(temp_overlap, aes(x = time, y = temp_c, color = site)) +
  geom_line(alpha = 0.7, size = 1.2) +
  theme_bw() + 
  theme(panel.grid = element_line(color = "white"),
        axis.title.x = element_text(color = "transparent"),
        axis.title.y = element_text(size = 18),
        axis.text.x = element_text(size = 18, color = "black", margin = margin(t = 5)),
        axis.text.y = element_text(size = 18, color = "black", margin = margin(l = 15)),
        legend.position = "none",
        legend.text = element_text(size = 25)) +
  xlab(label = "Month") +
  ylab(expression("Temperature " ( degree*C))) +
  scale_color_manual(name = "Site", labels = c("Mermaid Reef", "Sandy Cay"), values = c("#F8766D","#00BFC4"))

ggarrange(temp_time_overlap, density_plot,
                    labels = c("    a", "   b"),
          font.label = list(size = 21)) +
  theme(plot.margin=unit(c(1,1,3,0.5),"cm"), 
                         legend.position = "bottom")

ggsave(filename = "figures/temp_dens.png", width = 350, height = 175, units = "mm")
```

# Plot temperature over time just by month
```{r}
ggplot(df, aes(x = monthday, y = temp_c, color = site)) +
  geom_line(alpha = 0.3)
```

# Boxplot MR vs SC
```{r}
df %>%
  filter(time < "2015-10-15") %>%
  filter(site != "sandy_cay_nursery") %>%
  select(site, temp_c) %>%
  ggplot(aes(x = site, y = temp_c, fill = site)) +
  geom_boxplot()
```

# Linear model
```{r}
library(gamm4)
```

#Table of Metric Values 
```{r}
# Mean of all Temp Data
library(gridExtra)
library(grid)

mean(df$temp_c, na.rm = TRUE)

metrics<- df %>%
  filter(time < "2015-10-15") %>%
  filter(site != "sandy_cay_nursery") %>%
  group_by(site) %>%
  summarize(
    mean = mean(temp_c, na.rm = TRUE),
    min = min(temp_c, na.rm = TRUE),
    max = max(temp_c, na.rm = TRUE),
    median = median(temp_c, na.rm = TRUE))
```

```{r}
grid.table(metrics) 
```
